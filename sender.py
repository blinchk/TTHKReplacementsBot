import os
import random
import time

import pymysql
import requests
import vk_api
from bs4 import BeautifulSoup
from pymysql.cursors import DictCursor

print("Sender launched")

mysql_l = os.environ['MYSQL_LOGIN']
mysql_p = os.environ["MYSQL_PASS"]
access_token = os.environ["ACCESS_TOKEN"]
vk = vk_api.VkApi(token=access_token)


def write_msg(user_id, random_id, message):
    vk.method('messages.send', {'user_id': user_id, 'random_id': random_id, 'message': message})


def parsepage(table):
    muudatused = []
    for i in range(len(table)):
        my_table = table[i]
        rows = my_table.find_all('tr')
        for row in rows:
            muudatus = []
            cells = row.find_all('td')
            for cell in cells:
                if cell.text not in ["\xa0", "Kuup√§ev", "R√ºhm", "Tund", "√ïpetaja", "Ruum"]:
                    data = cell.text
                    muudatus.append(data)
            # –∑–¥–µ—Å—å –µ—Å—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ muudatus
            if muudatus != []:
                muudatused.append(muudatus)
        else:
            continue
    return muudatused

def openfromfile(usergroup):
    connection = pymysql.connect(
        host='eu-cdbr-west-02.cleardb.net',
        user=mysql_l,
        password=mysql_p,
        db='heroku_0ccfbccd1823b55',
        cursorclass=DictCursor)
    with connection.cursor() as cursor:
        cursor.execute("""SELECT * FROM USERS WHERE sendStatus=1""")
        row = cursor.fetchall()
        #        print(row)
        for i in row:
            #            print(i)
            usergroup[i['vkid']] = i['thkruhm']
    cursor.close()
    connection.close()
    return usergroup

def makemuudatused(i, forshow):
    if len(i) == 6:
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]} \nüë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: {i[4]}\n"
                       f"–ö–∞–±–∏–Ω–µ—Ç: {i[5]}\n")
    elif len(i) > 2 and i[3].lower() in "j√§√§b √§ra":
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü {i[2]}\n‚ùå –ù–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è\n")
    elif len(i) > 4 and i[4].lower() in "j√§√§b √§ra":
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]}\n‚ùå –ù–µ —Å–æ—Å—Ç–æ–∏—Ç—Å—è\n")
    elif len(i) > 4 and i[4].lower() in "s√∂√∂givahetund":
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]}\n ‚è∞ –£—Ä–æ–∫: {i[3]}\nüÜí –û–±–µ–¥–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ä—ã–≤\n")
    elif len(i) > 5 and i[5].lower() in "iseseisev t√∂√∂ kodus":
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]}\nüè† –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –¥–æ–º–∞\n")
    elif len(i) > 5 and i[5].lower() in "iseseisev t√∂√∂":
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]}\nüìã –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞\n")
    elif len(i) > 5 and (i[5].lower() == "" or i[5].lower() == " "):
        forshow.append(f"üóì {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]}\nüë®‚Äçüè´ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å: {i[4]}\n")
    else:
        forshow.append(f"üóì –í {i[0]} –î–∞—Ç–∞: {i[1]}\nü¶Ü –ì—Ä—É–ø–ø–∞: {i[2]} ‚è∞ –£—Ä–æ–∫: {i[3]}\n")
    return forshow

def getmuudatused(setgroup, user, justtable):
    forshow = []
    muudatused = parsepage(justtable)
    for i in muudatused:
        if setgroup.lower() in i[2].lower() and time.strftime("%d.%m.%Y") in i[1]:
            makemuudatused(i, forshow)
    if len(forshow) > 0:
        userfname = (vk.method('users.get', {'user_ids': user, 'fields': 'first_name'})[0])["first_name"]
        kogutunniplaan = f"–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ, {userfname}! –î–ª—è –≥—Ä—É–ø–ø—ã ü¶Ü {setgroup} –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ " \
                         f"—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏:\n"
        for w in forshow:
            kogutunniplaan += f"{w}\n"
        write_msg(user, (random.getrandbits(31) * random.choice([-1, 1])), kogutunniplaan)
    elif len(forshow) == 0:
        pass

def sendeveryday(justtable):
    usergroup = {}
    usergroup = openfromfile(usergroup)
    print("–ó–∞–ø—É—Å–∫–∞—é —Ä–∞—Å—Å—ã–ª–∫—É:")
    print(time.strftime("%H:%M:%S"))
    for i in usergroup.keys():
        getmuudatused(usergroup[i], i, justtable)

while True:
    if time.strftime("%H:%M:%S", time.localtime()) == '06:20:00' and time.strftime("%w", time.localtime()) in ['1', '2',
                                                                                                               '3', '4',
                                                                                                               '5']:
        r = requests.get('http://www.tthk.ee/tunniplaani-muudatused/')
        html_content = r.text
        soup = BeautifulSoup(html_content, 'html.parser')
        justtable = soup.findChildren('table')
        sendeveryday(justtable)
    time.sleep(1.1)
    continue
